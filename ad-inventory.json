<script>
(function () {
  const jsonURL = "https://raw.githubusercontent.com/safoorah-raya/ntca-ads/main/ad-inventory.json";

  const zones = {
    header: "mvBannerBottom",
    sidebar: "mvSkyScraper",
    footer: "mvLowerBanner"
  };

  function isActive(ad) {
    if (!ad.start || !ad.end) return true;
    const now = new Date();
    return new Date(ad.start) <= now && now <= new Date(ad.end);
  }

  function getRandomAd(ads) {
    return ads[Math.floor(Math.random() * ads.length)];
  }

  function fireImpression(ad, zone) {
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: "ad_impression",
      advertiser: ad.advertiser,
      campaign: ad.campaign,
      placement: zone,
      image: ad.img,
      timestamp: new Date().toISOString()
    });
  }

  function renderAd(zone, ad) {
    const container = document.getElementById(zones[zone]);
    if (!container || !ad) return;

    container.innerHTML = `
      <a href="${ad.url}" target="_blank" rel="noopener noreferrer">
        <img src="${ad.img}" alt="${ad.advertiser}" style="max-width:100%;display:block;" />
      </a>
    `;

    fireImpression(ad, zone);
  }

  function rotateAds(data) {
    for (const zone in zones) {
      let ads = data[zone];
      if (!ads || ads.length === 0) continue;

      ads = ads.filter(isActive);
      if (ads.length === 0) continue;

      const cycle = () => renderAd(zone, getRandomAd(ads));
      cycle();
      setInterval(cycle, 6000);
    }
  }

  fetch(jsonURL)
    .then(res => res.json())
    .then(data => rotateAds(data))
    .catch(err => console.error("Ad load error:", err));
})();
</script>
